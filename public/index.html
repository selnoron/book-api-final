<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>book store</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="container">
    <div class="nav">
      <h2>book store</h2>
      <div>
        <span id="userInfo"></span>
        <button id="logoutBtn">logout</button>
      </div>
    </div>

    <div id="adminBlock"></div>

    <h3>books</h3>
    <div id="books"></div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    async function init() {
      const user = await getMe()
      if (!user) {
        window.location.href = '/login.html'
        return
      }

      document.getElementById('userInfo').innerText = `${user.email} (${user.role})`
      document.getElementById('logoutBtn').addEventListener('click', logout)

      // флаг для админских кнопок
      window.__isAdmin = user.role === 'admin'

      if (window.__isAdmin) {
        document.getElementById('adminBlock').innerHTML = `
          <h3>add book (admin)</h3>
          <input id="title" placeholder="title" />
          <input id="author" placeholder="author" />
          <input id="price" type="number" step="0.01" placeholder="price" />
          <input id="image" type="file" accept="image/*" />
          <textarea id="description" placeholder="description"></textarea>
          <input id="genre" placeholder="genre (optional)" />
          <input id="year" type="number" placeholder="year (optional)" />
          <button id="createBtn">create</button>
          <hr />
        `

        document.getElementById('createBtn').addEventListener('click', createBook)
      }

      await loadBooks()
    }

    async function loadBooks() {
      const res = await fetch('/api/books')
      const data = await res.json()

      const el = document.getElementById('books')
      el.innerHTML = ''

      if (!res.ok) {
        el.innerHTML = `<p>error: ${escapeHtml(data.message || 'cannot load books')}</p>`
        return
      }

      if (!data.length) {
        el.innerHTML = `<p>no books yet</p>`
        return
      }

      data.forEach((b) => {
        el.innerHTML += `
          <div class="book">
            <h3>${escapeHtml(b.title)}</h3>
            <p>${escapeHtml(b.author)} — $${Number(b.price).toFixed(2)}</p>

            <div class="book-actions">
              <a href="/book.html?id=${b._id}">view details</a>
              ${
                window.__isAdmin
                  ? `<button class="danger" onclick="deleteBook('${b._id}')">delete</button>`
                  : ''
              }
            </div>
          </div>
        `
      })
    }

    async function createBook() {
      const token = getToken()
      if (!token) {
        alert('please login first')
        window.location.href = '/login.html'
        return
      }

      const titleEl = document.getElementById('title')
      const authorEl = document.getElementById('author')
      const priceEl = document.getElementById('price')
      const descEl = document.getElementById('description')
      const genreEl = document.getElementById('genre')
      const yearEl = document.getElementById('year')
      const imageEl = document.getElementById('image')

      const file = imageEl.files[0]
      if (!file) {
        alert('please choose an image')
        return
      }

      const formData = new FormData()
      formData.append('title', titleEl.value.trim())
      formData.append('author', authorEl.value.trim())
      formData.append('price', priceEl.value)
      formData.append('description', descEl.value.trim())

      if (genreEl.value.trim()) formData.append('genre', genreEl.value.trim())
      if (yearEl.value.trim()) formData.append('year', yearEl.value.trim())

      // важно: имя поля файла должно быть 'image'
      formData.append('image', file)

      const res = await fetch('/api/books', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`
        },
        body: formData
      })

      const data = await res.json()
      if (!res.ok) {
        alert(data.message || 'cannot create book')
        return
      }

      // чистим форму
      titleEl.value = ''
      authorEl.value = ''
      priceEl.value = ''
      descEl.value = ''
      genreEl.value = ''
      yearEl.value = ''
      imageEl.value = ''

      alert('book created')
      await loadBooks()
    }

    async function deleteBook(bookId) {
      if (!confirm('delete this book?')) return

      const token = getToken()
      if (!token) {
        alert('please login first')
        window.location.href = '/login.html'
        return
      }

      const res = await fetch(`/api/books/${bookId}`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${token}`
        }
      })

      const data = await res.json()
      if (!res.ok) {
        alert(data.message || 'cannot delete book')
        return
      }

      alert('book deleted')
      await loadBooks()
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;')
    }

    init()
  </script>
</body>
</html>
